function content_loader_init(e){arrPageContent.scroll_block_height=$(document).find(arrPageContent.scroll_block).prop("scrollHeight"),arrPageContent.from=0,parseInt(arrPageParams.from)&&(arrPageContent.from=arrPageParams.from),arrPageParams.scroll_block&&(arrPageContent.scroll_block=arrPageParams.scroll_block),parseInt(arrPageParams.parents)&&(arrPageContent.parents=arrPageParams.parents),parseInt(arrPageParams.id)&&(arrPageContent.id=arrPageParams.id),arrPageContent.scroll_nav=arrPageParams.scroll_nav?arrPageParams.scroll_nav:0,arrPageContent.full=!1,arrPageContent.table=arrPageParams.table,arrPageContent.sort=arrPageParams.sort,arrPageContent.sortdir=arrPageParams.sortdir,arrPageContent.filter=arrPageParams.filter,arrPageContent.form=arrPageParams.form,arrPageContent.limit=arrPageParams.limit?arrPageParams.limit:10,arrPageContent.elem_show_class=arrPageParams.elem_show_class,arrPageContent.content_selector=arrPageParams.content_selector,arrPageContent.elem_template_path=arrPageParams.elem_template_path,arrPageContent.elem_template_selector=arrPageParams.elem_template_selector,arrPageContent.oTemplate={},$(document).find(arrPageContent.content_selector).html('<small class="_loading"><i class="fa-solid fa-spinner fa-spin"></i></small>'),content_loader_template()}function content_loader_template(){arrPageContent.elem_template_path?$.get("/templates/"+arrPageContent.elem_template_path).fail(function(e){status({error:"Шаблон не найден: "+arrPageContent.elem_template_path})}).done(function(e){e&&(arrPageContent.oTemplate=$("<div/>").html(e),arrPageContent.from=0,arrPageParams.from=0,content_loader_load("start"),content_loader_scroll_init())}):arrPageContent.elem_template_selector&&(arrPageContent.oTemplate=$(document).find(arrPageContent.elem_template_selector),arrPageContent.from=0,arrPageParams.from=0,content_loader_load("start"),content_loader_scroll_init())}function content_loader_scroll_init(){arrPageContent.scroll_block?$(document).find(arrPageContent.scroll_block).on("scroll",content_loader_scroll_load):(arrPageContent.scroll_block||(arrPageContent.scroll_block=$(window).width()>=920?"#main_block_content":"html, body"),$(window).width()>=920?$(document).find("#main_block_content").on("scroll",content_loader_scroll_load):$(window).bind("scroll",content_loader_scroll_load))}function content_loader_scroll_load(){return!arrPageContent.scroll_block_disabled&&(!arrPageContent.full&&void(arrPageContent.scroll_nav?0==$(document).find(arrPageContent.scroll_block).scrollTop()&&(arrPageContent.from=parseInt(arrPageContent.from)+parseInt(arrPageContent.limit),content_loader_load("continue")):parseInt($(document).find(arrPageContent.scroll_block).height())+parseInt($(document).find(arrPageContent.scroll_block).scrollTop())>=$(document).find(arrPageContent.scroll_block).prop("scrollHeight")-100&&(arrPageContent.from=parseInt(arrPageContent.from)+parseInt(arrPageContent.limit),content_loader_load("continue"))))}function content_loader_load(e){arrPageContent.scroll_block_disabled=!0,$(document).find(arrPageContent.scroll_block).addClass("_no_scroll_"),$.when(content_download({action:arrPageContent.table,form:arrPageContent.form,parents:arrPageContent.parents,from:arrPageContent.from,sort:arrPageContent.sort,sortdir:arrPageContent.sortdir,limit:arrPageContent.limit,filter:arrPageContent.filter},"text",!1)).fail(function(e,t,a){$(document).find(arrPageContent.content_selector).html('<small class="_error_result"><span>Error: '+e.statusText+"("+e.status+')</span><i class="fa-solid fa-triangle-exclamation"></i></small>')}).then(function(t){if(!t||"[]"==t){var a="";return a="ru"==localStorage.getItem("lang")?"Тут пока что пусто":"It`s empty for now","start"==e&&$(document).find(arrPageContent.content_selector).html('<small class="_not_result"><span>'+a+'</span><i class="fa-solid fa-face-smile"></i></small>'),!1}"start"==e&&$(document).find(arrPageContent.content_selector).html("");var r=$.parseJSON(t),n="";if(r.length){arrPageParams.scroll_nav&&(r=r.reverse()),$.each(r,function(e,t){n+=content_loader_elem_html(t)}),arrPageParams.scroll_nav?($(document).find(arrPageContent.content_selector).prepend(n),r=r.reverse()):$(document).find(arrPageContent.content_selector).append(n);var o=0;$.each(r,function(t,a){setTimeout(function(){arrPageContent.elem_show_class?$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+a.id+'"]').addClass(arrPageContent.elem_show_class):$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+a.id+'"]').addClass("_show_")},150*o/2),r.length==o+1&&content_loader_scroll_to(e),o++}),r.length<10&&(arrPageContent.full=!0,$(document).find(arrPageContent.scroll_block).removeClass("_no_scroll_"),$(document).find(arrPageContent.scroll_block).removeClass("_scroll_"))}else arrPageContent.full=!0,$(document).find(arrPageContent.scroll_block).removeClass("_no_scroll_"),$(document).find(arrPageContent.scroll_block).removeClass("_scroll_")})}function content_loader_add(e){var t=content_loader_elem_html(e);arrPageParams.scroll_nav?$(document).find(arrPageContent.content_selector).append(t):$(document).find(arrPageContent.content_selector).prepend(t),setTimeout(function(){arrPageContent.elem_show_class?$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass(arrPageContent.elem_show_class):$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass("_show_")},150)}function content_loader_update(e){var t=content_loader_elem_html(e);$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass("_update_").after(t),$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]._update_').remove(),setTimeout(function(){arrPageContent.elem_show_class?$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass(arrPageContent.elem_show_class):$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass("_show_")},150)}function content_loader_del(e){$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').hide("slow"),setTimeout(function(){$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').remove()},150)}function content_loader_scroll_to(e){var t=$(document).find(arrPageContent.scroll_block).prop("scrollHeight"),a=t-arrPageContent.scroll_block_height;arrPageContent.scroll_block_height=t,$(document).find(arrPageContent.scroll_block).removeClass("_no_scroll_"),arrPageContent.scroll_block_disabled=!1,"start"==e&&(arrPageContent.scroll_nav?$(document).find(arrPageContent.content_selector).on("load",scroll_to(0,t,180,$(document).find(arrPageContent.scroll_block))):$(document).find(arrPageContent.content_selector).on("load",scroll_to(0,0,180,$(document).find(arrPageContent.scroll_block)))),"continue"==e&&scroll_to(0,a,0,$(document).find(arrPageContent.scroll_block))}function content_loader_elem_html(e,t){if(void 0===(t=t||arrPageContent.oTemplate))return!1;var a=[],r=[],n=$(t)[0].innerHTML;for(var o in e)if(a.push(o),r.push(e[o]),"object"==typeof e[o]){arrPageContent.arrayObjects&&(arrPageContent.arrayObjects[e.id]||(arrPageContent.arrayObjects[e.id]=[]),arrPageContent.arrayObjects[e.id][o]=e[o]);for(var l in e[o])a.push(o+"."+l),r.push(e[o][l])}for(var s=0;s<a.length;s++)""!=n&&""!=n&&a[s]&&r[s]&&n.indexOf("{{"+a[s]+"}}")&&(n=n.split("{{"+a[s]+"}}").join(r[s]));return n=n.replace(/{{(.*?)}}/g,"")}$.fn.content_loader=function(e){arrPageParams.table=this.data().content_loader_table,arrPageParams.form=this.data().content_loader_form,arrPageParams.from=this.data().content_loader_from,arrPageParams.limit=this.data().content_loader_limit,arrPageParams.sort=this.data().content_loader_sort,arrPageParams.sortdir=this.data().content_loader_sortdir,arrPageParams.scroll_block=this.data().content_loader_scroll_block,arrPageParams.scroll_nav=this.data().content_loader_scroll_nav,arrPageParams.parents=this.data().content_loader_parents,arrPageParams.filter=this.data().content_loader_filter,arrPageParams.content_selector="#"+this.attr("id"),arrPageParams.elem_show_class=this.data().content_loader_show_class,arrPageParams.elem_template_path=this.data().content_loader_template,arrPageParams.elem_template_selector=this.data().content_loader_template_selector,arrPageContent.arrayObjects=[],content_loader_init(e)},$(function(){$(document).on("click",".content_loader_show",function(){var e={action:$(this).data().action,form:$(this).data().form,parents:$(this).data().parents,id:$(this).data().id};if(e.data={},oElemSuccessClick={},$(this).data().success_click&&(oElemSuccessClick=$(document).find($(this).data().success_click)),$(this).data().full&&(e.data=$(this).data()),$(this).data().filter){var t=window.location;new URL(t).searchParams.forEach(function(t,a){void 0!==e.data[a]?(Array.isArray(params[a])||(e.data[a]=[params[a]]),e.data[a].push(t)):e.data[a]=t})}return $.when(content_download(e,"json",!1)).then(function(e){if(oElemSuccessClick.length&&oElemSuccessClick.click(),e.event)switch(e.event){case"add":content_loader_add(e.data)}e.form&&(oModal.set_content_full(e.form),oModal.show())}),!1}),$(document).on("submit","form#content_loader_save",function(){var e=$(this),t=$(this).serializeArray();return $.when(content_download(t,"json")).then(function(t){if(t.success){var a=500;if(t.success.location_time&&(a=t.success.location_time),t.success.data&&t.success.event)switch(t.success.event){case"reload":case"save":content_loader_update(t.success.data);break;case"add":content_loader_add(t.success.data);break;case"del":content_loader_del(t.success.data)}e.find('[name="success_click"]').length&&$(document).find(e.find('[name="success_click"]').val()).click(),t.success.location&&setTimeout(function(){$(location).attr("href",t.success.location)},a),t.success.location_reload&&setTimeout(function(){location.reload()},a)}t.location_reload&&setTimeout(function(){location.reload()},a)}),!1}),$(document).on("click",".content_loader_del",function(){if(!$(this).data().elem)return status({error:"No element selector to remove"}),!1;var e=$(this).parents($(this).data().elem);return!!confirm("Are you sure you want to delete this item?")&&($.when(content_download({action:$(this).data().action,form:$(this).data().form,id:$(this).data().id},"json")).then(function(t){t.success?e.remove():$.fancybox.open('<p class="error">'+t.error+"</p>")}),!1)})});